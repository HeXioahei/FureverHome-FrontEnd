# 🔧 帖子相关接口权限问题说明

## 📋 问题概述

### 问题1：删除帖子 ⚠️
**接口**: `DELETE /api/post/{id}`  
**问题**: 用户无法删除自己发布的帖子  
**错误信息**: `无此权限：post:delete`  
**HTTP状态码**: 500

### 问题2：编辑帖子 ⚠️
**接口**: `PUT /api/post/{id}`  
**问题**: 用户无法编辑自己发布的帖子  
**错误信息**: 可能也是权限相关错误  
**HTTP状态码**: 500

### 问题3：获取帖子详情 ⚠️
**接口**: `GET /api/post/{id}`  
**问题**: 用户无法获取自己发布的帖子详情  
**错误信息**: 返回 `data: null`  
**HTTP状态码**: 200（但数据为空）

## 🐛 问题现象

### 删除帖子
1. 用户在"我的帖子"页面点击删除按钮
2. 前端调用 `DELETE /api/post/{id}` 接口
3. 后端返回500错误，错误消息：`无此权限：post:delete`
4. 用户无法删除自己发布的帖子

### 编辑帖子
1. 用户在"我的帖子"页面点击编辑按钮
2. 前端跳转到编辑页面，先调用 `GET /api/post/{id}` 获取帖子详情
3. 后端返回 `data: null`，无法获取帖子详情
4. 前端使用备用数据（路由参数）才能继续编辑
5. 提交编辑时，调用 `PUT /api/post/{id}` 接口可能也会返回权限错误

### 获取帖子详情
1. 用户在"我的帖子"页面点击编辑按钮
2. 前端调用 `GET /api/post/{id}` 接口获取帖子详情
3. 后端返回：
   ```json
   {
     "code": 200,
     "message": "操作成功",
     "data": null
   }
   ```
4. 用户无法获取自己发布的帖子详情（可能是权限问题）

## 🔍 问题分析

### 当前权限检查逻辑（推测）

后端可能在检查权限时，要求用户必须有 `post:delete` 权限才能删除帖子：

```java
// 当前的逻辑（有问题）
if (!hasPermission("post:delete")) {
    throw new PermissionException("无此权限：post:delete");
}
```

### 问题所在

**这个逻辑不合理**，因为：
- ❌ 普通用户不应该有 `post:delete` 权限（这是管理员权限）
- ✅ 但普通用户应该可以删除**自己发布的帖子**

## ✅ 正确的逻辑

### 应该允许以下情况删除帖子：

1. ✅ **帖子作者** - 可以删除自己发布的帖子
2. ✅ **管理员** - 可以删除任何帖子
3. ❌ **其他用户** - 不能删除别人的帖子

### 正确的实现方式

#### 删除帖子接口

```java
@DeleteMapping("/{id}")
public ApiResponse<Void> deletePost(@PathVariable Long id) {
    // 1. 获取帖子信息
    Post post = postService.getById(id);
    if (post == null) {
        return ApiResponse.error(404, "帖子不存在");
    }
    
    // 2. 获取当前登录用户ID
    Long currentUserId = SecurityUtils.getCurrentUserId();
    
    // 3. 检查权限：是帖子作者 或 是管理员
    boolean isAuthor = post.getUserId().equals(currentUserId);
    boolean isAdmin = SecurityUtils.hasRole("ADMIN") || SecurityUtils.hasPermission("post:delete");
    
    if (!isAuthor && !isAdmin) {
        return ApiResponse.error(403, "您没有权限删除此帖子");
    }
    
    // 4. 执行删除
    postService.delete(id);
    return ApiResponse.success(null);
}
```

#### 获取帖子详情接口（需要修改）

```java
@GetMapping("/{id}")
public ApiResponse<Post> getPostDetail(@PathVariable Long id) {
    // 1. 获取帖子信息
    Post post = postService.getById(id);
    if (post == null) {
        return ApiResponse.error(404, "帖子不存在");
    }
    
    // 2. 获取当前登录用户ID（可能为null，未登录用户）
    Long currentUserId = SecurityUtils.getCurrentUserId();
    
    // 3. 检查权限：
    //    - 帖子作者可以查看自己的帖子（无论审核状态）
    //    - 管理员可以查看任何帖子
    //    - 其他用户只能查看已审核通过的帖子
    boolean isAuthor = currentUserId != null && post.getUserId().equals(currentUserId);
    boolean isAdmin = SecurityUtils.hasRole("ADMIN");
    boolean isApproved = "通过".equals(post.getReviewStatus()) || "approved".equals(post.getReviewStatus());
    
    if (!isAuthor && !isAdmin && !isApproved) {
        // 如果不是作者、不是管理员、且帖子未审核通过，返回空数据或权限错误
        // 注意：这里不应该返回404，因为帖子是存在的，只是用户没有权限查看
        return ApiResponse.error(403, "您没有权限查看此帖子");
    }
    
    // 4. 返回帖子详情
    return ApiResponse.success(post);
}
```

#### 编辑帖子接口（同样需要修改）

```java
@PutMapping("/{id}")
public ApiResponse<Post> updatePost(@PathVariable Long id, @RequestBody PostUpdateRequest request) {
    // 1. 获取帖子信息
    Post post = postService.getById(id);
    if (post == null) {
        return ApiResponse.error(404, "帖子不存在");
    }
    
    // 2. 获取当前登录用户ID
    Long currentUserId = SecurityUtils.getCurrentUserId();
    
    // 3. 检查权限：是帖子作者 或 是管理员
    boolean isAuthor = post.getUserId().equals(currentUserId);
    boolean isAdmin = SecurityUtils.hasRole("ADMIN") || SecurityUtils.hasPermission("post:update");
    
    if (!isAuthor && !isAdmin) {
        return ApiResponse.error(403, "您没有权限编辑此帖子");
    }
    
    // 4. 重要：编辑后审核状态的处理逻辑
    if (!isAdmin) {
        // 普通用户编辑：无论当前状态是什么，编辑后都变成"待审核"
        String currentStatus = post.getReviewStatus();
        if ("通过".equals(currentStatus) || "approved".equalsIgnoreCase(currentStatus)) {
            // 已审核通过的帖子，编辑后需要重新审核
            request.setReviewStatus("待审核");
        } else if ("拒绝".equals(currentStatus) || "rejected".equalsIgnoreCase(currentStatus)) {
            // 已拒绝的帖子，编辑后重新提交，变成待审核
            request.setReviewStatus("待审核");
        } else if ("待审核".equals(currentStatus) || "pending".equalsIgnoreCase(currentStatus)) {
            // 待审核的帖子，编辑后保持待审核状态
            request.setReviewStatus("待审核");
        }
    } else {
        // 管理员编辑：可以通过请求参数设置审核状态（通过/拒绝）
        // 如果请求中没有指定 reviewStatus，保持原有状态
        // 如果请求中指定了 reviewStatus，使用指定的状态
        // 注意：管理员可以通过编辑接口直接设置审核状态，不需要单独的审核接口
        if (request.getReviewStatus() != null) {
            // 管理员指定了审核状态，使用指定的状态
            // 允许的值："待审核"、"通过"、"拒绝"
            String newStatus = request.getReviewStatus();
            if ("待审核".equals(newStatus) || "通过".equals(newStatus) || "拒绝".equals(newStatus) ||
                "pending".equalsIgnoreCase(newStatus) || "approved".equalsIgnoreCase(newStatus) || "rejected".equalsIgnoreCase(newStatus)) {
                // 验证通过，使用指定的状态
                // request.setReviewStatus(newStatus); // 已经在请求中设置了
            }
        }
        // 如果管理员没有指定审核状态，保持原有状态（不修改 reviewStatus）
    }
    
    // 5. 执行更新
    Post updatedPost = postService.update(id, request);
    return ApiResponse.success(updatedPost);
}
```

**重要业务逻辑说明**：
- ✅ **已审核通过的帖子被编辑后，需要重新审核**
  - 如果帖子当前状态是"通过"，且是普通用户（非管理员）编辑
  - 编辑后应该将 `reviewStatus` 重置为"待审核"
  - 管理员编辑时保持原有审核状态（管理员有权限直接修改）

- ✅ **已拒绝的帖子编辑后，重新提交变成待审核**
  - 如果帖子当前状态是"拒绝"，普通用户编辑后
  - 编辑后应该将 `reviewStatus` 设置为"待审核"（重新提交审核）
  - 管理员编辑时保持原有审核状态

- ✅ **待审核的帖子编辑后，保持待审核状态**
  - 如果帖子当前状态是"待审核"，编辑后保持"待审核"状态
  - 不需要额外处理

**总结规则**：
| 当前审核状态 | 普通用户编辑后 | 管理员编辑后 |
|------------|--------------|-------------|
| 待审核 | 待审核（保持） | 可通过可不通过（管理员可设置） |
| 通过 | 待审核（重新审核） | 可通过可不通过（管理员可设置） |
| 拒绝 | 待审核（重新提交） | 可通过可不通过（管理员可设置） |

**说明**：
- **普通用户**：编辑后统一变成"待审核"，需要重新审核
- **管理员**：编辑时可以通过请求参数 `reviewStatus` 设置审核状态（"待审核"、"通过"、"拒绝"），如果不指定则保持原状态

## 📝 具体修改建议

### 方案1：在接口中检查作者身份（推荐）

在 `DELETE /api/post/{id}` 接口中：
1. 先获取帖子信息，拿到 `userId`（帖子作者ID）
2. 获取当前登录用户的ID
3. 如果当前用户是帖子作者，允许删除
4. 如果当前用户是管理员，也允许删除
5. 否则返回权限错误

### 方案2：修改权限配置

如果使用权限框架（如 Sa-Token），可以：
- 保留 `post:delete` 权限给管理员
- 在接口中单独检查是否是帖子作者
- 两者满足其一即可删除

## 🧪 测试场景

### 删除帖子测试场景

**场景1：帖子作者删除自己的帖子** ✅
- **用户**: 普通用户（ID: 123）
- **帖子**: 用户123发布的帖子
- **操作**: 删除
- **预期**: ✅ 删除成功
- **当前**: ❌ 权限错误（`无此权限：post:delete`）

**场景2：管理员删除任何帖子** ✅
- **用户**: 管理员
- **帖子**: 任何帖子
- **操作**: 删除
- **预期**: ✅ 删除成功
- **当前**: ✅ 应该正常（如果管理员有权限）

**场景3：普通用户删除别人的帖子** ❌
- **用户**: 普通用户（ID: 123）
- **帖子**: 用户456发布的帖子
- **操作**: 删除
- **预期**: ❌ 权限错误
- **当前**: ❌ 权限错误（这个是对的）

### 编辑帖子测试场景

**场景1：帖子作者编辑自己的帖子** ✅
- **用户**: 普通用户（ID: 123）
- **帖子**: 用户123发布的帖子
- **操作**: 编辑
- **预期**: ✅ 编辑成功
- **当前**: ⚠️ 可以编辑（但后端返回 `data: null`，前端使用备用数据）

**场景2：管理员编辑任何帖子** ✅
- **用户**: 管理员
- **帖子**: 任何帖子
- **操作**: 编辑
- **预期**: ✅ 编辑成功
- **当前**: ✅ 应该正常（如果管理员有权限）

**场景3：普通用户编辑别人的帖子** ❌
- **用户**: 普通用户（ID: 123）
- **帖子**: 用户456发布的帖子
- **操作**: 编辑
- **预期**: ❌ 权限错误
- **当前**: ❌ 权限错误（这个是对的）

### 获取帖子详情测试场景

**场景1：帖子作者查看自己的帖子** ✅
- **用户**: 普通用户（ID: 123）
- **帖子**: 用户123发布的帖子（无论审核状态）
- **操作**: 查看详情
- **预期**: ✅ 返回帖子详情
- **当前**: ❌ 返回 `data: null`

**场景2：管理员查看任何帖子** ✅
- **用户**: 管理员
- **帖子**: 任何帖子
- **操作**: 查看详情
- **预期**: ✅ 返回帖子详情
- **当前**: ✅ 应该正常（如果管理员有权限）

**场景3：普通用户查看已审核通过的帖子** ✅
- **用户**: 普通用户（ID: 123）
- **帖子**: 其他用户发布的已审核通过的帖子
- **操作**: 查看详情
- **预期**: ✅ 返回帖子详情
- **当前**: ✅ 应该正常

**场景4：普通用户查看未审核的帖子** ❌
- **用户**: 普通用户（ID: 123）
- **帖子**: 其他用户发布的未审核的帖子
- **操作**: 查看详情
- **预期**: ❌ 权限错误或返回空数据
- **当前**: ❌ 返回空数据（这个是对的）

## 📊 接口对比

| 接口 | 用途 | 权限要求 | 状态 |
|------|------|----------|------|
| `GET /api/post/{id}` | 获取帖子详情 | 帖子作者 **或** 管理员 **或** 已审核通过的帖子 | ⚠️ 需要修改 |
| `DELETE /api/post/{id}` | 用户删除自己的帖子 | 帖子作者 **或** 管理员 | ⚠️ 需要修改 |
| `PUT /api/post/{id}` | 用户编辑自己的帖子 | 帖子作者 **或** 管理员 | ⚠️ 需要修改 |
| `DELETE /admin/posts/{id}` | 管理员删除任何帖子 | 仅管理员 | ✅ 保持不变 |
| `PUT /admin/posts/{id}` | 管理员编辑任何帖子 | 仅管理员 | ✅ 保持不变 |

## 📝 重要业务逻辑说明

### 编辑帖子后审核状态的处理规则

**业务规则**：

1. ✅ **已审核通过的帖子被普通用户编辑后，需要重新审核**
   - 如果帖子当前状态是"通过"，且是普通用户（非管理员）编辑
   - 编辑后应该将 `reviewStatus` 重置为"待审核"
   - 用户会看到提示："您的帖子修改已提交成功，请等待审核结果。"

2. ✅ **已拒绝的帖子编辑后，重新提交变成待审核**
   - 如果帖子当前状态是"拒绝"，普通用户编辑后
   - 编辑后应该将 `reviewStatus` 设置为"待审核"（重新提交审核）
   - 用户会看到提示："您的帖子修改已提交成功，请等待审核结果。"

3. ✅ **待审核的帖子编辑后，保持待审核状态**
   - 如果帖子当前状态是"待审核"，编辑后保持"待审核"状态
   - 用户会看到提示："您的帖子修改已提交成功，请等待审核结果。"

4. ✅ **管理员编辑时可以设置审核状态**
   - 管理员有权限直接修改，不需要重新审核
   - 管理员编辑时，可以通过请求参数 `reviewStatus` 设置审核状态（"待审核"、"通过"、"拒绝"）
   - 如果管理员没有指定审核状态，则保持原有状态
   - 管理员可以决定编辑后的审核状态，不受原状态限制

**审核状态变化表**：

| 当前审核状态 | 普通用户编辑后 | 管理员编辑后 |
|------------|--------------|-------------|
| 待审核 | 待审核（保持） | 可通过可不通过（管理员可设置） |
| 通过 | 待审核（重新审核） | 可通过可不通过（管理员可设置） |
| 拒绝 | 待审核（重新提交） | 可通过可不通过（管理员可设置） |

**说明**：
- **普通用户**：编辑后统一变成"待审核"，需要重新审核
- **管理员**：编辑时可以通过请求参数 `reviewStatus` 设置审核状态，如果不指定则保持原状态

**实现逻辑**（已在代码示例中体现）：
```java
if (!isAdmin) {
    // 普通用户：无论当前状态是什么，编辑后都变成"待审核"
    request.setReviewStatus("待审核");
} else {
    // 管理员：可以通过请求参数设置审核状态
    // 如果请求中没有指定 reviewStatus，保持原有状态
    // 如果请求中指定了 reviewStatus，使用指定的状态
    if (request.getReviewStatus() != null) {
        // 验证审核状态值是否合法
        String newStatus = request.getReviewStatus();
        if (!("待审核".equals(newStatus) || "通过".equals(newStatus) || "拒绝".equals(newStatus) ||
              "pending".equalsIgnoreCase(newStatus) || "approved".equalsIgnoreCase(newStatus) || "rejected".equalsIgnoreCase(newStatus))) {
            return ApiResponse.error(400, "无效的审核状态值");
        }
        // 使用指定的状态
    }
    // 如果管理员没有指定审核状态，保持原有状态（不修改 reviewStatus）
}
```

**管理员编辑时的请求示例**：
```json
// 管理员编辑并设置审核状态为"通过"
{
  "title": "修改后的标题",
  "content": "修改后的内容",
  "reviewStatus": "通过"
}

// 管理员编辑并设置审核状态为"拒绝"
{
  "title": "修改后的标题",
  "content": "修改后的内容",
  "reviewStatus": "拒绝"
}

// 管理员编辑但不修改审核状态（保持原状态）
{
  "title": "修改后的标题",
  "content": "修改后的内容"
  // 不包含 reviewStatus 字段
}
```

## 🔗 相关接口

**需要修改的接口：**

1. `GET /api/post/{id}` - 获取帖子详情 ⚠️
   - **问题**: 返回 `data: null`，用户无法获取自己发布的帖子详情
   - **应该**: 允许帖子作者查看自己的帖子详情
   - **应该**: 允许管理员查看任何帖子详情
   - **应该**: 允许其他用户查看已审核通过的帖子详情

2. `PUT /api/post/{id}` - 编辑帖子 ⚠️
   - **问题**: 可能返回权限错误
   - **应该**: 允许帖子作者编辑自己的帖子
   - **应该**: 允许管理员编辑任何帖子

3. `DELETE /api/post/{id}` - 删除帖子 ⚠️
   - **问题**: 返回 `无此权限：post:delete`
   - **应该**: 允许帖子作者删除自己的帖子
   - **应该**: 允许管理员删除任何帖子

## 💡 沟通要点

**跟后端同学说：**

> "你好，有三个帖子相关的接口权限检查有问题：
> 
> **问题1：删除帖子** `DELETE /api/post/{id}`
> - 当前：要求用户必须有 `post:delete` 权限
> - 应该：允许帖子作者删除自己的帖子（不需要特殊权限）
> 
> **问题2：编辑帖子** `PUT /api/post/{id}`
> - 当前：可能也有权限问题
> - 应该：允许帖子作者编辑自己的帖子
> 
> **问题3：获取帖子详情** `GET /api/post/{id}`
> - 当前：返回 `data: null`，用户无法获取自己发布的帖子详情
> - 应该：允许帖子作者查看自己的帖子（无论审核状态）
> 
> **需要修改的逻辑**：
> 1. 检查当前用户是否是帖子作者（`post.userId == currentUserId`）
> 2. 检查当前用户是否是管理员
> 3. 两者满足其一即可操作
> 
> 详细说明和代码示例在文档中，请查看。"

## 📎 参考信息

- **前端调用位置**: `src/views/user/UserCenter/MyPosts.vue`
- **错误信息**: `无此权限：post:delete`
- **HTTP状态码**: 500
- **帖子ID**: 43（测试时）

## ✅ 修复后的验证

修复后，请验证：

### 获取帖子详情功能
1. ✅ 帖子作者可以查看自己的帖子（无论审核状态）
2. ✅ 管理员可以查看任何帖子
3. ✅ 普通用户可以查看已审核通过的帖子
4. ✅ 普通用户不能查看未审核的别人的帖子

### 删除功能
5. ✅ 帖子作者可以删除自己的帖子
6. ✅ 管理员可以删除任何帖子  
7. ✅ 普通用户不能删除别人的帖子

### 编辑功能
8. ✅ 帖子作者可以编辑自己的帖子
9. ✅ 管理员可以编辑任何帖子
10. ✅ 普通用户不能编辑别人的帖子

---

**感谢！** 🙏

